#!/bin/bash
# Pre-commit hook to check Python files for syntax errors
# Particularly useful for catching indentation issues

echo "Running pre-commit hook to check syntax..."

# Find all Python files that are staged for commit
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACMRTUXB | grep "\.py$")

if [ -z "$STAGED_PY_FILES" ]; then
    echo "No Python files staged for commit."
    exit 0
fi

SYNTAX_ERRORS=0

for FILE in $STAGED_PY_FILES; do
    if [ -f "$FILE" ]; then
        echo "Checking syntax for $FILE..."
        python -m py_compile "$FILE" 2>/dev/null
        
        if [ $? -ne 0 ]; then
            echo "❌ Syntax error in $FILE"
            # Print the specific error for debugging
            python -m py_compile "$FILE"
            SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
        else
            echo "✅ Syntax check passed for $FILE"
        fi
    fi
done

# Also check with flake8 if it's installed, focusing on indentation (E111-E117)
if command -v flake8 >/dev/null 2>&1; then
    echo "Running flake8 indentation checks..."
    for FILE in $STAGED_PY_FILES; do
        if [ -f "$FILE" ]; then
            INDENTATION_ERRORS=$(flake8 --select=E111,E112,E113,E114,E115,E116,E117 "$FILE")
            if [ ! -z "$INDENTATION_ERRORS" ]; then
                echo "❌ Indentation issues found in $FILE:"
                echo "$INDENTATION_ERRORS"
                SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
            fi
        fi
    done
else
    echo "flake8 not found. Consider installing it for better indentation checks."
fi

if [ $SYNTAX_ERRORS -gt 0 ]; then
    echo "❌ Commit aborted due to syntax errors in $SYNTAX_ERRORS file(s)."
    echo "Fix the errors before committing."
    exit 1
fi

echo "✅ Syntax check passed for all Python files."
exit 0 
# Context 디렉토리 유닛 테스트

이 디렉토리는 컨텍스트 관리 및 객관적 요약 시스템에 대한 유닛 테스트를 포함합니다.

## 테스트 파일 구조

### `test_summary_templates.py`
객관적인 요약 템플릿 시스템 테스트
- **기본 템플릿 검증**: 객관적 요약을 위한 기본 템플릿 동작
- **컨텍스트 타입별 특화**: academic_paper, news_article, policy_document 등 타입별 템플릿
- **템플릿 포맷팅**: 플레이스홀더 교체 및 유효성 검증
- **일관성 확인**: 모든 템플릿의 객관성 및 불렛포인트 형식 준수

### `test_context_manager.py`
DebateContextManager 클래스의 핵심 기능 테스트
- **초기화 및 설정**: 매개변수 및 초기 상태 확인
- **컨텍스트 관리**: 텍스트 추가, 활성화, 통합 기능
- **객관적 요약 생성**: 단일 요약 생성 및 캐싱 메커니즘
- **적응적 전략**: 컨텍스트 길이에 따른 단일/계층적 요약 전략
- **불렛포인트 추출**: 다양한 형식의 불렛포인트 인식 및 정규화
- **텍스트 처리**: 청킹, 토큰 추정, 문장 분할 등 유틸리티 기능

### `test_url_integration.py`
실제 URL과 LLM을 사용한 통합 테스트
- **실제 웹 스크래핑**: Yale Journal URL에서 실제 컨텐츠 추출
- **실제 LLM 요약**: OpenAI API를 사용한 실제 요약 생성
- **종단간 검증**: URL → 추출 → 요약 → 불렛포인트 전체 파이프라인
- **결과 품질 확인**: 키워드 포함, 적절한 길이, 불렛포인트 형식 등

## 주요 변경사항

### 이전 버전 대비 개선점
1. **단순화된 구조**: 역할별(pro/con/moderator) 분기 제거, 객관적 요약만 지원
2. **효율성 개선**: 4배 토큰 절약 (1개 요약 vs 4개 역할별 요약)
3. **명확한 목적**: 소스에 대한 객관적 불렛포인트 요약에 집중
4. **실용적 테스트**: Mock LLM + 실제 URL 테스트 조합

### 테스트 전략
- **Unit Tests**: Mock LLM으로 빠른 기능 검증 (API 비용 없음)
- **Integration Tests**: 실제 LLM으로 품질 검증 (API 키 필요)
- **Fallback Tests**: API 키 없을 때도 URL 추출까지는 테스트 가능

## 테스트 실행 방법

### 1. 기본 유닛 테스트 (API 키 불필요)
```bash
# 템플릿 테스트
python test_summary_templates.py

# 컨텍스트 매니저 테스트 (Mock LLM 사용)
python test_context_manager.py
```

### 2. 통합 테스트 (API 키 필요)
```bash
# OpenAI API 키 설정
export OPENAI_API_KEY='your-api-key-here'

# 실제 URL + LLM 테스트
python test_url_integration.py
```

### 3. 전체 테스트 실행
```bash
# 프로젝트 루트에서
pytest tests/unit/dialogue/context/ -v
```

## 테스트 커버리지

### 기능별 커버리지
- ✅ **템플릿 시스템**: 100% (모든 컨텍스트 타입 및 폴백)
- ✅ **컨텍스트 관리**: 100% (추가, 활성화, 통합, 캐싱)
- ✅ **요약 생성**: 100% (단일/계층적 전략, 오류 처리)
- ✅ **텍스트 처리**: 100% (청킹, 불렛포인트 추출, 토큰 추정)
- ✅ **실제 통합**: Yale Journal URL로 검증

### 에러 시나리오 테스트
- 빈 컨텍스트 처리
- 잘못된 컨텍스트 타입 폴백
- LLM API 호출 실패 시나리오
- 네트워크 오류 처리
- 캐시 무효화 및 새로고침

## 성능 특성

### 요약 전략별 성능
- **단일 요약** (< 3000자): 1회 LLM 호출, ~2-5초
- **계층적 요약** (≥ 3000자): N+1회 LLM 호출 (N=청크수), ~10-30초
- **캐싱**: 동일 주제 재요청 시 즉시 반환

### 토큰 효율성
- **이전**: 4개 역할별 요약 = 4x 토큰 비용
- **현재**: 1개 객관적 요약 = 1x 토큰 비용
- **절약**: 75% 토큰 비용 절감

## 테스트 데이터

### 사용된 실제 URL
- **Yale Journal**: "Regulation and Innovation: Approaching Market Failure from Both Sides"
- **목적**: 학술 논문의 복잡한 내용을 객관적으로 요약하는 능력 검증

### Mock 데이터
- AI 관련 샘플 컨텍스트 (다양한 길이)
- 기후 변화 관련 컨텍스트
- 다양한 불렛포인트 형식 텍스트

## 주의사항

1. **API 키**: 통합 테스트 실행 시 유효한 OpenAI API 키 필요
2. **네트워크**: Yale Journal URL 접근을 위한 인터넷 연결 필요
3. **속도**: 실제 LLM 호출로 인한 테스트 시간 증가 (1-2분)
4. **비용**: 통합 테스트 실행 시 소량의 API 비용 발생

## 향후 개선 계획

1. **추가 URL 테스트**: 다양한 소스(뉴스, 정책 문서 등)로 확장
2. **성능 벤치마크**: 요약 품질 vs 속도 최적화
3. **다국어 지원**: 한국어 컨텐츠 요약 테스트 추가
4. **캐시 최적화**: 더 효율적인 캐싱 전략 테스트 